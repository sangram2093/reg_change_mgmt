<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Compare Regulatory Graphs - DEBUG</title>
  <script src="https://cdn.jsdelivr.net/npm/neovis.js@2.0.2"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      height: 100%;
      overflow: hidden;
    }
    h1 {
      text-align: center;
      padding: 10px 0;
      background-color: #f7f7f7;
      margin: 0;
      font-size: 20px;
    }
    .graph-row {
      display: flex;
      height: 60vh;
    }
    .graph-section {
      width: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .graph-box {
      width: 95%;
      height: 90%;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-top: 10px;
    }
    .delta-section {
      height: 40vh;
      padding: 20px;
      overflow-y: auto;
    }
    pre {
      background-color: #f4f4f4;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ddd;
      overflow-x: auto;
      max-height: 100%;
    }
  </style>
</head>
<body>

  <h1>Regulatory Change Comparison (Debug Mode)</h1>

  <div class="graph-row">
    <div class="graph-section">
      <h2>Old Regulation: {{ old_filename }}</h2>
      <div class="graph-box" id="oldViz"></div>
    </div>
    <div class="graph-section">
      <h2>New Regulation: {{ new_filename }}</h2>
      <div class="graph-box" id="newViz"></div>
    </div>
  </div>

  <div class="delta-section">
    <h2>Detected Changes (Delta)</h2>
    <pre>{{ delta_summary }}</pre>
  </div>

  <script>
    function renderGraph(containerId, versionLabel, useFallback = false) {
      const cypher = useFallback
        ? "MATCH (n) RETURN n LIMIT 25"
        : `MATCH (a:Entity {version: '${versionLabel}'})-[r:ACTION]->(b:Entity {version: '${versionLabel}'}) RETURN a, r, b`;

      const config = {
        containerId: containerId,
        neo4j: {
          serverUrl: "bolt://localhost:7687",
          serverUser: "neo4j",
          serverPassword: "your_password"
        },
        labels: {
          Entity: {
            caption: function (node) {
              return node.properties?.name || node.properties?.id || "Unnamed";
            },
            size: "pagerank",
            community: "type"
          }
        },
        relationships: {
          ACTION: {
            caption: function (rel) {
              return rel.properties?.name || "ACTION";
            },
            thickness: "confidence_score"
          }
        },
        layout: "force",
        initialCypher: cypher
      };

      const viz = new NeoVis.default(config);
      console.log("⏳ Attempting to render:", containerId);
      viz.render();

      let retryCount = 0;
      const interval = setInterval(() => {
        if (viz._network && viz._network.body && viz._network.body.data) {
          console.log(`✅ GRAPH READY for: ${containerId}`);
          console.log("Nodes:", viz._network.body.data.nodes.get());
          console.log("Edges:", viz._network.body.data.edges.get());
          viz._network.fit();
          clearInterval(interval);
        } else {
          retryCount++;
          if (retryCount > 10) {
            console.warn(`⚠️ Timeout waiting for graph on: ${containerId}. Trying fallback query...`);
            clearInterval(interval);
            if (!useFallback) {
              renderGraph(containerId, versionLabel, true);
            } else {
              alert(`Graph failed to load for ${containerId}.`);
            }
          }
        }
      }, 500);
    }

    window.onload = function () {
      renderGraph("oldViz", "old");
      renderGraph("newViz", "new");
    };
  </script>

</body>
</html>
